!function(a){function b(a,b,c){var d=new Object;return d.from=a,d.to=b,d.content=c,d.time=new Date,d}function c(a,b){return new Date(a.time)-new Date(b.time)}function d(b,d){console.log("append "+b+" to"+d);var e,g=b+"to"+d,h=d+"to"+b,i=localStorage.getItem(g),j=localStorage.getItem(h),k=sessionStorage.getItem("myimage"),l=sessionStorage.getItem("talkto_image");if(null==i){e=JSON.parse(j);for(var m in e)e[m].from==b?a("#single-chat").append("<li class=info-user><img class=use-img src="+k+"><span>"+f(e[m].content)+"</span></li><div class=clear></div>"):a("#single-chat").append("<li class=info-friend><img class=use-img src="+l+"><span>"+f(e[m].content)+"</span></li><div class=clear></div>")}else if(null==j){e=JSON.parse(i);for(var m in e)e[m].from==b?a("#single-chat").append("<li class=info-user><img class=use-img src="+k+"><span>"+f(e[m].content)+"</span></li><div class=clear></div>"):a("#single-chat").append("<li class=info-friend><img class=use-img src="+l+"><span>"+f(e[m].content)+"</span></li><div class=clear></div>")}else{e=JSON.parse(i);var n=JSON.parse(j),o=e.concat(n);o.sort(c);for(var m in o)o[m].from==b?a("#single-chat").append("<li class=info-user><img class=use-img src="+k+"><span>"+f(o[m].content)+"</span></li><div class=clear></div>"):a("#single-chat").append("<li class=info-friend><img class=use-img src="+l+"><span>"+f(o[m].content)+"</span></li><div class=clear></div>")}console.log("append end")}function e(){for(var b=0;20>=b;b++)a("#emoji1 ul").append("<li text="+b+"></li>");for(var b=0;20>=b;b++)a("#emoji1 ul").append("<li text="+b+"></li>")}function f(a){for(var b,c,d=a,e=/\[emoji:\d+\]/g,f=170;b=e.exec(a);)c=b[0].slice(7,-1),d=c>f?d.replace(b[0],"[X]"):d.replace(b[0],'<img class="emoji" src="http://7xiwi7.com1.z0.glb.clouddn.com/emoji'+c+'.gif" />');return d}a("#register-back").click(function(){a("register-box").addClass("hidden"),a("login-box").removeClass("hidden")});var g=0;a(function(){a("textarea").autosize();var c,h,i=io();i.on("connect",function(a){}),i.on("is login",function(d){d.status?(a(".login-box").removeClass("bounceIn"),a(".login-box").addClass("flipOutY"),a(".login-box").addClass("hidden"),a(".login-box").addClass("hidden"),a(".user-list").removeClass("hidden"),a(".my-image").attr("src",d.user.image_url),a(".myname").html(d.user.name),sessionStorage.setItem("myimage",d.user.image_url),g=2,console.log("to"+d.user.account),i.on("get message",function(d){if(3==g)if(d.from==c){var e=f(d.content),h=navigator.userAgent;console.log(h),a("#single-chat").append("<li class=info-friend><img class=use-img src="+d.image_url+"><span>"+e+"</span></li><div class=clear></div>")}else a("#chatlist li").each(function(){var b=a(this).find("input").val();b==d.from&&a(this).css("background-image","url(/img/shake.gif)")});else(2==g||4==g)&&a("#chatlist li").each(function(){var b=a(this).find("input").val();b==d.from&&a(this).css("background-image","url(/img/shake.gif)")});var i=d.from+"to"+d.to;console.log(i);var j=localStorage.getItem(i);if(console.log(j),null==j){console.log("store first");var k=new Array;k[0]=b(d.from,d.to,d.content),localStorage.setItem(i,JSON.stringify(k))}else{console.log("store first");var l=JSON.parse(j),m=l.length;l[m]=b(d.from,d.to,d.content),localStorage.setItem(i,JSON.stringify(l)),console.log(l)}})):a(".login_error").removeClass("hidden")}),i.on("userlist",function(b){console.log(b.mapSize),console.log(b),a(".list-adapter ul").html("");for(var c in b.map){var d=b.map[c];a(".list-adapter ul").append("<li><img src="+d.image_url+" class='friend-logo'/><div class=friend-info-left><p class=friend-name><a href=#>"+d.name+"</a><input type=hidden value="+d.account+"></p><p class=friend-info>127.0.0.1</p></div><span class=last-time>12:32</span></li>")}}),i.on("multi talk",function(b){a("#multi-area").append("<li class=info-user><img class=use-img src="+b.image_url+"><p>"+b.name+"</p><span class=span-append>"+f(b.content)+"</span></li><div class=clear></div>")}),i.on("forceoffline",function(){alert("�����˺��������ط���¼��")}),i.on("shake it",function(b){b==sessionStorage.getItem("talkto")&&(a(".chat-ui").addClass("tada"),setInterval(function(){a(".chat-ui").removeClass("tada")},2e3))}),i.on("register result",function(b){-1==b.isok?(a(".register_error").removeClass("hidden"),a(".register_error").html("���˺��Ѿ�����")):(a(".register_error").removeClass("hidden"),a(".register_error").html("ע���ɹ������ص�¼�ɣ�"))}),e(),a(".emojiWrap img").addClass("emoji"),a(".emojiWrap img").bind("click",function(b){var c=a(b.currentTarget).attr("title");if(3==g){var d=a("#msg-input").val();d=d+"[emoji:"+c+"]",a("#msg-input").val(d)}else if(4==g){var d=a("#multi-msg-input").val();d=d+"[emoji:"+c+"]",a("#multi-msg-input").val(d)}}),a(".emojiWrap li").bind("click",function(b){var c=a(b.currentTarget).attr("text"),d=a("#msg-input").val();d=d+"[emoji:"+c+"]",a("#msg-input").val(d)}),a("#login").click(function(b){var c=a("#account").val(),d=a("#password").val();sessionStorage.setItem("account",c),i.emit("login",{account:c,password:d})}),a(window).unload(function(){var a=sessionStorage.getItem("account");i.emit("close",a)}),a(".friend-name a").live("click",function(b){var e=a(b.currentTarget).next(),f=a(e).parents().filter("li");h=f.children().eq(0).attr("src"),a(f).css("background-image","");var i=a(b.currentTarget).html();c=e.val(),sessionStorage.setItem("talkto",c),sessionStorage.setItem("talkto_image",h),c!=sessionStorage.getItem("account")&&(sessionStorage.setItem("talkto",c),a(".user-list").addClass("hidden"),a(".chat-ui").removeClass("hidden"),a("#single-chat").html(""),a(".to-name").html(i),d(sessionStorage.getItem("account"),c),g=3)}),a("#send").click(function(){var b=a("#emojiWrap");b.hasClass("hidden")||b.addClass("hidden");var c=a("#msg-input").val(),d=f(c),e=a(".my-image").attr("src");a("#single-chat").append("<li class=info-user><img class=use-img src="+e+"><span>"+d+"</span></li><div class=clear></div>"),a("#msg-input").val("");var g=sessionStorage.getItem("talkto"),h=sessionStorage.getItem("account");null!=g&&i.emit("send message",h,g,{from:h,to:g,content:c,image_url:e})}),a("#multi-send").click(function(){var b=a("#multi-msg-input").val(),c=a(".my-image").attr("src"),d=a(".myname").html(),e=sessionStorage.getItem("account");a("#multi-area").append("<li class=info-user><img class=use-img src="+c+"><p>"+d+"</p><span class=span-append>"+f(b)+"</span></li><div class=clear></div>"),a("#multi-msg-input").val(""),i.emit("broadcast",{account:e,name:d,image_url:c,content:b})}),a("#singleChatBack").click(function(){a(".chat-ui").addClass("hidden"),a(".user-list").removeClass("hidden"),g=2}),a("#enter-chatroom").click(function(){a(".user-list").addClass("hidden"),a(".chat-ui-multi").removeClass("hidden"),g=4}),a("#multiChatBack").click(function(){a(".chat-ui-multi").addClass("hidden"),a(".user-list").removeClass("hidden"),g=2}),a(".go-register").click(function(){a(".login-box").addClass("hidden"),a(".register-box").removeClass("hidden")}),a("#register-back").click(function(){a(".register-box").addClass("hidden"),a(".login-box").removeClass("hidden")}),a("#enter-register").click(function(){var b=a("#reg_account").val(),c=a("#reg-passwd").val(),d=a("#re-passwd").val();return console.log(b),console.log(c),c!=d?(a(".register_error").removeClass("hidden"),void a(".register_error").html("�������벻һ��")):b&&c?void i.emit("register",b,c):(a(".register_error").removeClass("hidden"),void a(".register_error").html("�˺����벻��Ϊ��"))}),a(".shakeke").click(function(){i.emit("shake",sessionStorage.getItem("account"),sessionStorage.getItem("talkto"))})}),a("#Iemoji").click(function(){a("#emojiWrap").toggleClass("hidden"),a("#single-chat").toggleClass("emojiUp")}),a("#Iemoji2").click(function(){a("#emojiWrap2").toggleClass("hidden")})}(jQuery),function(a){var b,c={className:"autosizejs",id:"autosizejs",append:"\n",callback:!1,resizeDelay:10,placeholder:!0},d='<textarea tabindex="-1" style="position:absolute; top:-999px; left:0; right:auto; bottom:auto; border:0; padding: 0; -moz-box-sizing:content-box; -webkit-box-sizing:content-box; box-sizing:content-box; word-wrap:break-word; height:0 !important; min-height:0 !important; overflow:hidden; transition:none; -webkit-transition:none; -moz-transition:none;"/>',e=["fontFamily","fontSize","fontWeight","fontStyle","letterSpacing","textTransform","wordSpacing","textIndent"],f=a(d).data("autosize",!0)[0];f.style.lineHeight="99px","99px"===a(f).css("lineHeight")&&e.push("lineHeight"),f.style.lineHeight="",a.fn.autosize=function(d){return this.length?(d=a.extend({},c,d||{}),f.parentNode!==document.body&&a(document.body).append(f),this.each(function(){function c(){var b,c=window.getComputedStyle?window.getComputedStyle(m,null):!1;c?(b=m.getBoundingClientRect().width,(0===b||"number"!=typeof b)&&(b=parseInt(c.width,10)),a.each(["paddingLeft","paddingRight","borderLeftWidth","borderRightWidth"],function(a,d){b-=parseInt(c[d],10)})):b=Math.max(n.width(),0),f.style.width=b+"px"}function g(){var g={};if(b=m,f.className=d.className,f.id=d.id,j=parseInt(n.css("maxHeight"),10),a.each(e,function(a,b){g[b]=n.css(b)}),a(f).css(g).attr("wrap",n.attr("wrap")),c(),window.chrome){var h=m.style.width;m.style.width="0px",m.offsetWidth,m.style.width=h}}function h(){var a,e;b!==m?g():c(),f.value=!m.value&&d.placeholder?(n.attr("placeholder")||"")+d.append:m.value+d.append,f.style.overflowY=m.style.overflowY,e=parseInt(m.style.height,10),f.scrollTop=0,f.scrollTop=9e4,a=f.scrollTop,j&&a>j?(m.style.overflowY="scroll",a=j):(m.style.overflowY="hidden",k>a&&(a=k)),a+=o,e!==a&&(m.style.height=a+"px",p&&d.callback.call(m,m))}function i(){clearTimeout(l),l=setTimeout(function(){var a=n.width();a!==r&&(r=a,h())},parseInt(d.resizeDelay,10))}var j,k,l,m=this,n=a(m),o=0,p=a.isFunction(d.callback),q={height:m.style.height,overflow:m.style.overflow,overflowY:m.style.overflowY,wordWrap:m.style.wordWrap,resize:m.style.resize},r=n.width();n.data("autosize")||(n.data("autosize",!0),("border-box"===n.css("box-sizing")||"border-box"===n.css("-moz-box-sizing")||"border-box"===n.css("-webkit-box-sizing"))&&(o=n.outerHeight()-n.height()),k=Math.max(parseInt(n.css("minHeight"),10)-o||0,n.height()),n.css({overflow:"hidden",overflowY:"hidden",wordWrap:"break-word",resize:"none"===n.css("resize")||"vertical"===n.css("resize")?"none":"horizontal"}),"onpropertychange"in m?"oninput"in m?n.on("input.autosize keyup.autosize",h):n.on("propertychange.autosize",function(){"value"===event.propertyName&&h()}):n.on("input.autosize",h),d.resizeDelay!==!1&&a(window).on("resize.autosize",i),n.on("autosize.resize",h),n.on("autosize.resizeIncludeStyle",function(){b=null,h()}),n.on("autosize.destroy",function(){b=null,clearTimeout(l),a(window).off("resize",i),n.off("autosize").off(".autosize").css(q).removeData("autosize")}),h())})):this}}(window.jQuery||window.$);